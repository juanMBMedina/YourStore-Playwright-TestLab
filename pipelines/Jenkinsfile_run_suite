pipeline {
    agent any

    environment {
        SUITE = "login"
        BROWSER = "chrome"
        WORKERS = "2"
    }

    parameters {
        choice(
            name: 'SUITE',
            choices: ['login', 'register', 'add-to-cart', 'all-tests'],
            description: 'Select the test suite to run'
        )
        choice(
            name: 'BROWSER',
            choices: ['chrome', 'edge', 'firefox'],
            description: 'Select the browser for test execution'
        )
        string(
            name: 'WORKERS',
            defaultValue: '1',
            description: 'Number of parallel processes to run tests'
        )

        string(
            name: 'COVERAGE',
            choices: ['false', 'true'],
            defaultValue: 'false',
            description: 'Enable or disable code coverage reporting'
        )
    }

    stages {
        stage('Run Playwright Tests in Docker') {
            steps {
                script {
                    echo "Running Playwright tests for suite: ${params.SUITE} on browser: ${params.BROWSER}"
                    def playwrightCommand = ''
                    def coverage = params.COVERAGE == 'true'

                    if (params.SUITE == 'all-tests' && !params.COVERAGE){
                        playwrightCommand = 'npm run test:all'
                    }else if (params.SUITE != 'all-tests' && params.COVERAGE) {
                        playwrightCommand = 'npm run test:coverage'
                    }else if (params.SUITE != 'all-tests' && !params.COVERAGE) {
                        playwrightCommand = 'npm run test'
                    }

                    env.SUITE = params.SUITE
                    env.BROWSER = params.BROWSER
                    env.WORKERS = params.WORKERS

                    sh """
                        docker-compose -f docker-compose.yml run --rm \
                            -e SUITE=${env.SUITE} \
                            -e BROWSER=${env.BROWSER} \
                            -e WORKERS=${env.WORKERS} \
                            playwright ${playwrightCommand}
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Tests executed successfully. Playwright report is available.'
        }
        failure {
            echo 'Tests failed. Please check the execution logs and generated report.'
        }
        always {
            script {
                // Use the same docker-compose file as in run
                sh "docker-compose -f docker-compose.yml down"

                echo 'Store Playwright Reports'
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: './playwright-report/',
                    reportFiles: 'index.html',
                    reportName: "${params.SUITE}-Playwright-Report"
                ])
                echo 'Pipeline execution finished.'
            }
        }
    }
}
